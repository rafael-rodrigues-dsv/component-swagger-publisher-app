<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ api.info.title }} - Confluence Preview</title>
    <style>
        {{ css_content }}
    </style>
</head>
<body>
    <!-- Confluence Header -->
    <div class="confluence-header">
        <div class="confluence-logo">‚ö° Confluence Preview</div>
        <div class="confluence-breadcrumb">
            Space: {{ space_key }} / {{ api.info.title }}
        </div>
    </div>

    <!-- Main Layout -->
    <div class="confluence-layout">
        <!-- Sidebar Navigation (Page Tree) -->
        <nav class="confluence-sidebar">
            <div class="space-info">
                <div class="space-name">{{ api.info.title }}</div>
                <div class="space-key">{{ space_key }}</div>
            </div>

            <ul class="page-tree">
                <!-- Root Page -->
                <li class="page-tree-item">
                    <a href="#overview" class="page-tree-link active" onclick="showPage('overview')">
                        <span class="page-icon">üìÑ</span>
                        <span>Overview</span>
                    </a>
                </li>

                <!-- Endpoints by Tag -->
                {% if api.tags %}
                <li class="page-tree-item">
                    <a href="#" class="page-tree-link">
                        <span class="page-icon">üìÅ</span>
                        <span>Endpoints</span>
                    </a>
                    <ul class="page-tree-children">
                        {% for tag in api.tags %}
                        <li class="page-tree-item">
                            <a href="javascript:void(0)" class="page-tree-link tag-folder" onclick="toggleFolder('folder-{{ tag.name }}')">
                                <span class="page-icon">üìÅ</span>
                                <span>{{ tag.name }}</span>
                                <span class="folder-arrow">‚ñ∂</span>
                            </a>
                            <ul id="folder-{{ tag.name }}" class="page-tree-children" style="display:none;">
                                {% for path, path_item in api.paths.items() %}
                                    {% for method, operation in path_item.operations.items() %}
                                        {% if tag.name in operation.tags %}
                                        {% set endpoint_id = (tag.name + '-' + method + '-' + path)|replace('/', '-')|replace('{', '')|replace('}', '') %}
                                        <li class="page-tree-item">
                                            <a href="#endpoint-{{ endpoint_id }}" class="page-tree-link" onclick="showPage('endpoint-{{ endpoint_id }}')">
                                                <span class="http-method-icon method-{{ method.lower() }}">{{ method[:1] }}</span>
                                                <span class="endpoint-path">{{ method.upper() }} {{ path }}</span>
                                            </a>
                                        </li>
                                        {% endif %}
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </li>
                        {% endfor %}
                    </ul>
                </li>
                {% endif %}

                <!-- Schemas -->
                {% if api.components.schemas %}
                <li class="page-tree-item">
                    <a href="#schemas" class="page-tree-link" onclick="showPage('schemas')">
                        <span class="page-icon">üìä</span>
                        <span>Data Models</span>
                    </a>
                </li>
                {% endif %}

                <!-- Security -->
                {% if api.components.security_schemes %}
                <li class="page-tree-item">
                    <a href="#security" class="page-tree-link" onclick="showPage('security')">
                        <span class="page-icon">üîê</span>
                        <span>Security</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>

        <!-- Main Content Area -->
        <main class="confluence-content">
            <!-- Preview Notice -->
            <div class="preview-notice">
                <span class="preview-notice-icon">‚ö†Ô∏è</span>
                <div>
                    <strong>Confluence Preview Mode</strong> - This is a simulation of how your documentation will appear in Confluence. The actual published version will have the same structure and styling.
                </div>
            </div>

            <!-- Page: Overview -->
            <div id="page-overview" class="page-content">
                <div class="page-header">
                    <h1 class="page-title">{{ api.info.title }}</h1>
                    <div class="page-metadata">
                        Version {{ api.info.version }} ‚Ä¢ OpenAPI {{ api.openapi_version }}
                    </div>
                    {% if api.tags %}
                    <div class="page-labels">
                        {% for tag in api.tags %}
                        <span class="label">{{ tag.name }}</span>
                        {% endfor %}
                        <span class="label">v{{ api.info.version }}</span>
                    </div>
                    {% endif %}
                </div>

                {% if api.info.description %}
                <div class="content-section">
                    <p>{{ api.info.description }}</p>
                </div>
                {% endif %}

                <!-- Info Macro: Base URLs -->
                {% if api.servers %}
                <div class="info-macro">
                    <span class="info-macro-icon">‚ÑπÔ∏è</span>
                    <strong>Base URLs</strong>
                    <ul style="margin: 8px 0 0 24px;">
                        {% for server in api.servers %}
                        <li><code>{{ server.url }}</code>{% if server.description %} - {{ server.description }}{% endif %}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Summary Table -->
                <div class="content-section">
                    <h2 class="section-title">API Summary</h2>
                    <table class="confluence-table">
                        <tr>
                            <th style="width: 30%;">Property</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td><strong>Title</strong></td>
                            <td>{{ api.info.title }}</td>
                        </tr>
                        <tr>
                            <td><strong>Version</strong></td>
                            <td>{{ api.info.version }}</td>
                        </tr>
                        <tr>
                            <td><strong>OpenAPI Version</strong></td>
                            <td>{{ api.openapi_version }}</td>
                        </tr>
                        <tr>
                            <td><strong>Total Endpoints</strong></td>
                            <td>{{ api.paths|length }}</td>
                        </tr>
                        {% if api.tags %}
                        <tr>
                            <td><strong>Tags</strong></td>
                            <td>{{ api.tags|length }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>

                <!-- Quick Links -->
                <div class="content-section">
                    <h2 class="section-title">Quick Navigation</h2>
                    <ul>
                        {% for tag in api.tags %}
                        <li><a href="#tag-{{ tag.name }}" onclick="showPage('tag-{{ tag.name }}')">{{ tag.name }} Endpoints</a></li>
                        {% endfor %}
                        {% if api.components.schemas %}
                        <li><a href="#schemas" onclick="showPage('schemas')">Data Models</a></li>
                        {% endif %}
                        {% if api.components.security_schemes %}
                        <li><a href="#security" onclick="showPage('security')">Security Configuration</a></li>
                        {% endif %}
                    </ul>
                </div>
            </div>

            <!-- Pages: Individual Endpoints -->
            {% for tag in api.tags %}
                {% for path, path_item in api.paths.items() %}
                    {% for method, operation in path_item.operations.items() %}
                        {% if tag.name in operation.tags %}
                        {% set endpoint_id = (tag.name + '-' + method + '-' + path)|replace('/', '-')|replace('{', '')|replace('}', '') %}
                        <div id="page-endpoint-{{ endpoint_id }}" class="page-content" style="display:none;">
                            <div class="page-header">
                                <h1 class="page-title">
                                    <span class="http-method method-{{ method.lower() }}">{{ method.upper() }}</span>
                                    {{ path }}
                                </h1>
                                <div class="page-metadata">{{ operation.summary or 'Endpoint' }}</div>
                                <div class="page-labels">
                                    <span class="label">{{ tag.name }}</span>
                                    <span class="label">{{ method.lower() }}</span>
                                </div>
                            </div>

                            {% if operation.description %}
                            <div class="content-section">
                                <p>{{ operation.description }}</p>
                            </div>
                            {% endif %}

                            <!-- Parameters -->
                            {% if operation.parameters %}
                            <div class="content-section">
                                <h2 class="section-title">Parameters</h2>
                                <table class="confluence-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Location</th>
                                            <th>Type</th>
                                            <th>Required</th>
                                            <th>Description</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for param in operation.parameters %}
                                        <tr>
                                            <td><code>{{ param.name }}</code></td>
                                            <td>{{ param.location }}</td>
                                            <td>
                                                {% if param.schema %}
                                                    {% if param.schema.ref %}
                                                        {% set model_name = param.schema.ref.split('/')[-1] %}
                                                        <a href="javascript:showPage('schemas')" class="schema-link" title="View in Data Models">{{ model_name }}</a>
                                                    {% elif param.schema.type %}
                                                        <code>{{ param.schema.type }}</code>
                                                    {% else %}
                                                        <code>object</code>
                                                    {% endif %}
                                                {% else %}
                                                    <code>string</code>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if param.required %}
                                                <span class="status-lozenge status-warning">Required</span>
                                                {% else %}
                                                <span class="status-lozenge status-default">Optional</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ param.description or '-' }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% endif %}

                            <!-- Request Body -->
                            {% if operation.request_body %}
                            <div class="content-section">
                                <h2 class="section-title">Request Body</h2>
                                <table class="confluence-table">
                                    <thead>
                                        <tr>
                                            <th>Content Type</th>
                                            <th>Schema</th>
                                            <th>Required</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for content_type, media_obj in operation.request_body.content.items() %}
                                        <tr>
                                            <td><code>{{ content_type }}</code></td>
                                            <td>
                                                {% if media_obj.schema %}
                                                    {% if media_obj.schema.ref %}
                                                        {% set model_name = media_obj.schema.ref.split('/')[-1] %}
                                                        <a href="javascript:showPage('schemas')" class="schema-link" title="View in Data Models">{{ model_name }}</a>
                                                    {% elif media_obj.schema.type %}
                                                        <code>{{ media_obj.schema.type }}</code>
                                                    {% else %}
                                                        <code>object</code>
                                                    {% endif %}
                                                {% else %}
                                                    <code>object</code>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if operation.request_body.required %}
                                                <span class="status-lozenge status-warning">Required</span>
                                                {% else %}
                                                <span class="status-lozenge status-default">Optional</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                {% if operation.request_body.description %}
                                <p style="margin-top: 8px; font-style: italic; color: #6B778C;">{{ operation.request_body.description }}</p>
                                {% endif %}
                            </div>
                            {% endif %}

                            <!-- Responses -->
                            {% if operation.responses %}
                            <div class="content-section">
                                <h2 class="section-title">Responses</h2>
                                <table class="confluence-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 100px;">Status</th>
                                            <th>Description</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for status, response in operation.responses.items() %}
                                        <tr>
                                            <td>
                                                {% if status.startswith('2') %}
                                                <span class="status-lozenge status-success">{{ status }}</span>
                                                {% elif status.startswith('4') %}
                                                <span class="status-lozenge status-warning">{{ status }}</span>
                                                {% else %}
                                                <span class="status-lozenge status-error">{{ status }}</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ response.description }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% endif %}

                            <!-- cURL Example -->
                            <div class="content-section">
                                <h2 class="section-title">cURL Example</h2>
                                <div class="code-block">
                                    <pre><code class="language-bash">curl -X {{ method.upper() }} '{% if api.servers and api.servers|length > 0 %}{{ api.servers[0].url }}{% else %}https://api.example.com{% endif %}{{ path }}'{% if operation.parameters %}{% for param in operation.parameters %}{% if param.location == 'path' %} # Replace {{ param.name }}{% endif %}{% endfor %}{% endif %} \
  -H 'Accept: application/json'{% if method.lower() in ['post', 'put', 'patch'] %} \
  -H 'Content-Type: application/json'{% if operation.request_body %} \
  -d '{"key": "value"}'{% endif %}{% endif %}</code></pre>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% endfor %}

            <!-- Page: Schemas -->
            {% if api.components.schemas %}
            <div id="page-schemas" class="page-content" style="display:none;">
                <div class="page-header">
                    <h1 class="page-title">Data Models</h1>
                    <div class="page-metadata">Schema Definitions</div>
                    <div class="page-labels">
                        <span class="label">schemas</span>
                        <span class="label">models</span>
                    </div>
                </div>

                <!-- Group schemas by tag based on endpoint usage -->
                {% for tag in api.tags %}
                <div class="content-section">
                    <h2 class="section-title" id="schema-{{ tag.name }}">{{ tag.name }} Schemas</h2>

                    {% set tag_schemas = [] %}
                    {# Find schemas used by this tag's endpoints #}
                    {% for path, path_item in api.paths.items() %}
                        {% for method, operation in path_item.operations.items() %}
                            {% if tag.name in operation.tags %}
                                {# Check request body schemas #}
                                {% if operation.request_body %}
                                    {% for content_type, media_obj in operation.request_body.content.items() %}
                                        {% if media_obj.schema and media_obj.schema.ref %}
                                            {% set model_name = media_obj.schema.ref.split('/')[-1] %}
                                            {% if model_name not in tag_schemas %}
                                                {% set _ = tag_schemas.append(model_name) %}
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                {# Check parameter schemas #}
                                {% if operation.parameters %}
                                    {% for param in operation.parameters %}
                                        {% if param.schema and param.schema.ref %}
                                            {% set model_name = param.schema.ref.split('/')[-1] %}
                                            {% if model_name not in tag_schemas %}
                                                {% set _ = tag_schemas.append(model_name) %}
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {% if tag_schemas|length > 0 %}
                        {% for schema_name in tag_schemas %}
                            {% if schema_name in api.components.schemas %}
                                {% set schema = api.components.schemas[schema_name] %}
                                <div class="panel-macro" style="margin-bottom: 24px;" id="schema-{{ schema_name }}">
                                    <div class="panel-header">{{ schema_name }}</div>
                                    {% if schema.description %}
                                    <p style="margin-bottom: 12px;">{{ schema.description }}</p>
                                    {% endif %}

                                    {% if schema.properties %}
                        <table class="confluence-table">
                            <thead>
                                <tr>
                                    <th>Property</th>
                                    <th>Type</th>
                                    <th>Required</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for prop_name, prop in schema.properties.items() %}
                                <tr>
                                    <td><code>{{ prop_name }}</code></td>
                                    <td><code>{{ prop.type or 'object' }}</code></td>
                                    <td>
                                        {% if prop_name in schema.required %}
                                        <span class="status-lozenge status-warning">Required</span>
                                        {% else %}
                                        <span class="status-lozenge status-default">Optional</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ prop.description or '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% endif %}
                    </div>
                    {% endif %}
                {% endfor %}
                    {% else %}
                        <p style="color: #6B778C; font-style: italic;">No schemas used by {{ tag.name }} endpoints.</p>
                    {% endif %}
                </div>
                {% endfor %}

                <!-- Other schemas not associated with any tag -->
                {% set used_schemas = [] %}
                {% for tag in api.tags %}
                    {% for path, path_item in api.paths.items() %}
                        {% for method, operation in path_item.operations.items() %}
                            {% if tag.name in operation.tags %}
                                {% if operation.request_body %}
                                    {% for content_type, media_obj in operation.request_body.content.items() %}
                                        {% if media_obj.schema and media_obj.schema.ref %}
                                            {% set model_name = media_obj.schema.ref.split('/')[-1] %}
                                            {% if model_name not in used_schemas %}
                                                {% set _ = used_schemas.append(model_name) %}
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                {% if operation.parameters %}
                                    {% for param in operation.parameters %}
                                        {% if param.schema and param.schema.ref %}
                                            {% set model_name = param.schema.ref.split('/')[-1] %}
                                            {% if model_name not in used_schemas %}
                                                {% set _ = used_schemas.append(model_name) %}
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                {% endfor %}

                {% set has_other_schemas = false %}
                {% for schema_name in api.components.schemas %}
                    {% if schema_name not in used_schemas %}
                        {% set has_other_schemas = true %}
                    {% endif %}
                {% endfor %}

                {% if has_other_schemas %}
                <div class="content-section">
                    <h2 class="section-title">Other Schemas</h2>
                    {% for schema_name, schema in api.components.schemas.items() %}
                        {% if schema_name not in used_schemas %}
                        <div class="panel-macro" style="margin-bottom: 24px;" id="schema-{{ schema_name }}">
                            <div class="panel-header">{{ schema_name }}</div>
                            {% if schema.description %}
                            <p style="margin-bottom: 12px;">{{ schema.description }}</p>
                            {% endif %}

                            {% if schema.properties %}
                            <table class="confluence-table">
                                <thead>
                                    <tr>
                                        <th>Property</th>
                                        <th>Type</th>
                                        <th>Required</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for prop_name, prop in schema.properties.items() %}
                                    <tr>
                                        <td><code>{{ prop_name }}</code></td>
                                        <td><code>{{ prop.type or 'object' }}</code></td>
                                        <td>
                                            {% if prop_name in schema.required %}
                                            <span class="status-lozenge status-warning">Required</span>
                                            {% else %}
                                            <span class="status-lozenge status-default">Optional</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ prop.description or '-' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Page: Security -->
            {% if api.components.security_schemes %}
            <div id="page-security" class="page-content" style="display:none;">
                <div class="page-header">
                    <h1 class="page-title">Security</h1>
                    <div class="page-metadata">Authentication & Authorization</div>
                    <div class="page-labels">
                        <span class="label">security</span>
                        <span class="label">authentication</span>
                    </div>
                </div>

                <div class="content-section">
                    {% for scheme_name, scheme in api.components.security_schemes.items() %}
                    <div class="panel-macro" style="margin-bottom: 16px;">
                        <div class="panel-header">{{ scheme_name }}</div>
                        <p><strong>Type:</strong> {{ scheme.type }}</p>
                        {% if scheme.description %}
                        <p>{{ scheme.description }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </main>
    </div>

    <script>
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.style.display = 'none';
            });

            // Remove active class from all links
            document.querySelectorAll('.page-tree-link').forEach(link => {
                link.classList.remove('active');
            });

            // Show selected page
            const page = document.getElementById('page-' + pageId);
            if (page) {
                page.style.display = 'block';
            }

            // Add active class to clicked link
            const activeLink = document.querySelector(`a[href="#${pageId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }

            // Scroll to top
            document.querySelector('.confluence-content').scrollTop = 0;
        }

        function toggleFolder(folderId) {
            const folder = document.getElementById(folderId);
            const arrow = event.currentTarget.querySelector('.folder-arrow');

            if (folder) {
                if (folder.style.display === 'none') {
                    folder.style.display = 'block';
                    if (arrow) arrow.textContent = '‚ñº';
                } else {
                    folder.style.display = 'none';
                    if (arrow) arrow.textContent = '‚ñ∂';
                }
            }
        }

        // Expand all folders on page load
        window.addEventListener('load', function() {
            document.querySelectorAll('[id^="folder-"]').forEach(folder => {
                folder.style.display = 'block';
            });
            document.querySelectorAll('.folder-arrow').forEach(arrow => {
                arrow.textContent = '‚ñº';
            });
        });
    </script>
</body>
</html>

