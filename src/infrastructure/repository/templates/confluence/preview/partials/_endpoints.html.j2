{# Endpoints: All endpoint pages with parameters + request + response + curl #}
{# INLINE SCHEMAS + SECURITY - Self-contained endpoints #}

{% for tag in api.tags %}
    {% for path, path_item in api.paths.items() %}
        {% for method, operation in path_item.operations.items() %}
            {% if tag.name in operation.tags %}
            {% set endpoint_id = (tag.name + '-' + method + '-' + path)|replace('/', '-')|replace('{', '')|replace('}', '') %}

            {# ============================================= #}
            {# ENDPOINT PAGE #}
            {# ============================================= #}
            <div id="page-endpoint-{{ endpoint_id }}" class="page-content" style="display:none;">
                <div class="page-header">
                    <h1 class="page-title">
                        <span class="http-method method-{{ method.lower() }}">{{ method.upper() }}</span>
                        {{ path }}
                    </h1>
                    <div class="page-metadata">{{ operation.summary or 'Endpoint' }}</div>
                    <div class="page-labels">
                        <span class="label">{{ tag.name }}</span>
                        <span class="label">{{ method.lower() }}</span>
                    </div>
                </div>

                {% if operation.description %}
                <div class="content-section">
                    <p>{{ operation.description }}</p>
                </div>
                {% endif %}

                {# ============================================= #}
                {# SECURITY INLINE #}
                {# ============================================= #}
                {% if operation.security or (api.security and api.security|length > 0) %}
                <div class="content-section">
                    <div class="info-macro">
                        <span style="font-size: 18px; margin-right: 8px;">üîê</span>
                        <strong>Authentication Required</strong>
                        {% if api.components and api.components.security_schemes %}
                            {% for scheme_name, scheme in api.components.security_schemes.items() %}
                                <p style="margin-top: 8px;">
                                    <strong>Type:</strong> {{ scheme.type }}<br>
                                    {% if scheme.type == 'http' %}
                                        <strong>Scheme:</strong> {{ scheme.scheme or 'bearer' }}<br>
                                        <strong>Header:</strong> <code>Authorization: Bearer {token}</code>
                                    {% elif scheme.type == 'apiKey' %}
                                        <strong>Header:</strong> <code>{{ scheme.name or 'X-API-Key' }}: {your-api-key}</code><br>
                                        <strong>Location:</strong> {{ scheme['in'] or 'header' }}
                                    {% elif scheme.type == 'oauth2' %}
                                        <strong>OAuth 2.0</strong> authentication required
                                    {% endif %}
                                    {% if scheme.description %}
                                    <br><em>{{ scheme.description }}</em>
                                    {% endif %}
                                </p>
                            {% endfor %}
                        {% else %}
                            <p style="margin-top: 8px;"><em>Authentication details not specified in API specification</em></p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {# ============================================= #}
                {# PARAMETERS #}
                {# ============================================= #}
                {% if operation.parameters %}
                <div class="content-section">
                    <h2 class="section-title">Parameters</h2>
                    <table class="confluence-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Location</th>
                                <th>Type</th>
                                <th>Required</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for param in operation.parameters %}
                            <tr>
                                <td><code>{{ param.name }}</code></td>
                                <td>{{ param.location }}</td>
                                <td>
                                    {% if param.schema %}
                                        {% if param.schema.ref %}
                                            {% set model_name = param.schema.ref.split('/')[-1] %}
                                            <a href="javascript:showPage('schemas')" class="schema-link" title="View in Data Models">{{ model_name }}</a>
                                        {% elif param.schema.type %}
                                            <code>{{ param.schema.type }}</code>
                                        {% else %}
                                            <code>object</code>
                                        {% endif %}
                                    {% else %}
                                        <code>string</code>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if param.required %}
                                        <span class="status-lozenge status-warning">Required</span>
                                    {% else %}
                                        <span class="status-lozenge status-default">Optional</span>
                                    {% endif %}
                                </td>
                                <td>{{ param.description or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}

                {# ============================================= #}
                {# REQUEST BODY - SIMPLE TABLE ONLY #}
                {# ============================================= #}
                {% if operation.request_body %}
                <div class="content-section">
                    <h2 class="section-title">Request Body</h2>

                    {% if operation.request_body.description %}
                    <p style="font-style: italic; color: #6B778C;">{{ operation.request_body.description }}</p>
                    {% endif %}

                    <table class="confluence-table">
                        <thead>
                            <tr>
                                <th style="width: 30%;">Content Type</th>
                                <th style="width: 50%;">Schema</th>
                                <th style="width: 20%;">Required</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for content_type, media_obj in operation.request_body.content.items() %}
                            <tr>
                                <td><code>{{ content_type }}</code></td>
                                <td>
                                    {% if media_obj.schema %}
                                        {% if media_obj.schema.ref %}
                                            {% set model_name = media_obj.schema.ref.split('/')[-1] %}
                                            <strong>{{ model_name }}</strong>
                                        {% elif media_obj.schema.type == 'array' and media_obj.schema.items %}
                                            {% if media_obj.schema.items.ref %}
                                                {% set item_model_name = media_obj.schema.items.ref.split('/')[-1] %}
                                                <strong>array[{{ item_model_name }}]</strong>
                                            {% else %}
                                                <code>array[{{ media_obj.schema.items.type or 'object' }}]</code>
                                            {% endif %}
                                        {% elif media_obj.schema.type %}
                                            <code>{{ media_obj.schema.type }}</code>
                                        {% else %}
                                            <code>object</code>
                                        {% endif %}
                                    {% else %}
                                        <code>object</code>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if operation.request_body.required %}
                                    <span class="status-lozenge status-warning">Required</span>
                                    {% else %}
                                    <span class="status-lozenge status-default">Optional</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    {# Request Body JSON Example #}
                    {% for content_type, media_obj in operation.request_body.content.items() %}
                        {% if 'json' in content_type %}
                        <h3 style="margin-top: 16px; font-size: 14px; font-weight: 600;">Example</h3>
                        <div class="code-block">
                            <pre><code class="language-json">{% if media_obj.example %}{{ media_obj.example | tojson_pretty }}{% elif media_obj.schema %}{{ example_generator.generate_example_json(media_obj.schema) }}{% else %}{}{% endif %}</code></pre>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}

                {# ============================================= #}
                {# RESPONSES - WITH SCHEMA REFERENCE TABLE #}
                {# ============================================= #}
                {% if operation.responses %}
                <div class="content-section">
                    <h2 class="section-title">Responses</h2>
                    {% for status, response in operation.responses.items() %}
                    <div class="response-item" style="margin-bottom: 20px; padding: 12px; background: #f4f5f7; border-radius: 4px;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            {% if status.startswith('2') %}
                            <span class="status-lozenge status-success">{{ status }}</span>
                            {% elif status.startswith('4') %}
                            <span class="status-lozenge status-warning">{{ status }}</span>
                            {% else %}
                            <span class="status-lozenge status-error">{{ status }}</span>
                            {% endif %}
                            <span style="margin-left: 12px;">{{ response.description }}</span>
                        </div>

                        {# SCHEMA REFERENCE TABLE #}
                        {% if response.content %}
                        <table class="confluence-table" style="margin-top: 12px;">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Content Type</th>
                                    <th style="width: 50%;">Schema</th>
                                    <th style="width: 20%;">Has Content</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for content_type, media_obj in response.content.items() %}
                                <tr>
                                    <td><code>{{ content_type }}</code></td>
                                    <td>
                                        {% if media_obj.schema %}
                                            {% if media_obj.schema.ref %}
                                                {% set model_name = media_obj.schema.ref.split('/')[-1] %}
                                                <strong>{{ model_name }}</strong>
                                            {% elif media_obj.schema.type == 'array' and media_obj.schema.items %}
                                                {% if media_obj.schema.items.ref %}
                                                    {% set item_model_name = media_obj.schema.items.ref.split('/')[-1] %}
                                                    <strong>array[{{ item_model_name }}]</strong>
                                                {% elif media_obj.schema.items.type %}
                                                    <code>array[{{ media_obj.schema.items.type }}]</code>
                                                {% else %}
                                                    <code>array[object]</code>
                                                {% endif %}
                                            {% elif media_obj.schema.type %}
                                                <code>{{ media_obj.schema.type }}</code>
                                            {% else %}
                                                <code>object</code>
                                            {% endif %}
                                        {% else %}
                                            <code>-</code>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if media_obj.schema %}
                                        <span class="status-lozenge status-success">Yes</span>
                                        {% else %}
                                        <span class="status-lozenge status-default">No</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% endif %}

                        {# Response Body Example #}
                        {% if response.content %}
                            {% for content_type, media_obj in response.content.items() %}
                                {% if 'json' in content_type %}
                                {% set example_json = media_obj.example | tojson_pretty if media_obj.example else (example_generator.generate_example_json(media_obj.schema) if media_obj.schema else '{}') %}
                                {% if example_json.strip() not in ['{}', '""', 'null', ''] %}
                                <div style="margin-top: 12px;">
                                    <strong style="font-size: 12px; color: #6B778C;">Response Example ({{ content_type }}):</strong>
                                    <div class="code-block" style="margin-top: 8px;">
                                        <pre><code class="language-json">{{ example_json }}</code></pre>
                                    </div>
                                </div>
                                {% endif %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {# ============================================= #}
                {# CURL EXAMPLE #}
                {# ============================================= #}
                <div class="content-section">
                    <h2 class="section-title">cURL Example</h2>
                    <div class="code-block">
                        <pre><code class="language-bash">curl -X {{ method.upper() }} '{% if api.servers and api.servers|length > 0 %}{{ api.servers[0].url }}{% else %}https://api.example.com{% endif %}{{ path }}'{% if operation.parameters %}{% for param in operation.parameters %}{% if param.location == 'path' %} # Replace {{ param.name }}{% endif %}{% endfor %}{% endif %} \
  -H 'Accept: application/json'{% if method.lower() in ['post', 'put', 'patch'] %} \
  -H 'Content-Type: application/json'{% if operation.request_body %}{% for content_type, media_obj in operation.request_body.content.items() %}{% if 'json' in content_type %} \
  -d '{% if media_obj.example %}{{ media_obj.example | tojson_pretty | replace("'", "\\'") }}{% elif media_obj.schema %}{{ example_generator.generate_example_json(media_obj.schema) | replace("'", "\\'") }}{% else %}{"key": "value"}{% endif %}'{% endif %}{% endfor %}{% endif %}{% endif %}</code></pre>
                    </div>
                </div>

                {# ============================================= #}
                {# COMPLETE SCHEMA REFERENCE - ALL SCHEMAS + SUB-SCHEMAS #}
                {# ============================================= #}
                {% set all_schemas_to_display = [] %}
                {% set schemas_metadata = {} %}

                    {# Collect schemas from Request Body #}
                    {% if operation.request_body %}
                        {% for content_type, media_obj in operation.request_body.content.items() %}
                            {% if media_obj.schema %}
                                {% if media_obj.schema.ref %}
                                    {% set model_name = media_obj.schema.ref.split('/')[-1] %}
                                    {% if model_name not in all_schemas_to_display %}
                                        {% set _ = all_schemas_to_display.append(model_name) %}
                                        {% set _ = schemas_metadata.update({model_name: {'source': 'Request Body', 'color': '#0052CC', 'is_array': false}}) %}
                                    {% endif %}
                                {% elif media_obj.schema.type == 'array' and media_obj.schema.items and media_obj.schema.items.ref %}
                                    {% set model_name = media_obj.schema.items.ref.split('/')[-1] %}
                                    {% if model_name not in all_schemas_to_display %}
                                        {% set _ = all_schemas_to_display.append(model_name) %}
                                        {% set _ = schemas_metadata.update({model_name: {'source': 'Request Body', 'color': '#0052CC', 'is_array': true}}) %}
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    {# Collect schemas from Responses #}
                    {% if operation.responses %}
                        {% for status, response in operation.responses.items() %}
                            {% if response.content %}
                                {% for content_type, media_obj in response.content.items() %}
                                    {% if media_obj.schema %}
                                        {% if media_obj.schema.ref %}
                                            {% set model_name = media_obj.schema.ref.split('/')[-1] %}
                                            {% if model_name not in all_schemas_to_display %}
                                                {% set _ = all_schemas_to_display.append(model_name) %}
                                                {% set _ = schemas_metadata.update({model_name: {'source': 'Response ' + status, 'color': '#00875A', 'is_array': false}}) %}
                                            {% endif %}
                                        {% elif media_obj.schema.type == 'array' and media_obj.schema.items and media_obj.schema.items.ref %}
                                            {% set model_name = media_obj.schema.items.ref.split('/')[-1] %}
                                            {% if model_name not in all_schemas_to_display %}
                                                {% set _ = all_schemas_to_display.append(model_name) %}
                                                {% set _ = schemas_metadata.update({model_name: {'source': 'Response ' + status, 'color': '#00875A', 'is_array': true}}) %}
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    {# Only show Complete Schema Reference section if there are schemas to display #}
                    {% if all_schemas_to_display|length > 0 %}
                    <div class="content-section">
                        <h2 class="section-title">üìã Complete Schema Reference</h2>
                        <p style="font-style: italic; color: #6B778C; margin-bottom: 16px;">
                            Detailed schema definitions for all objects and sub-objects used in this endpoint.
                        </p>

                    {# Now process each schema and collect sub-schemas #}
                    {% set processed_schemas = [] %}
                    {% for schema_name in all_schemas_to_display %}
                        {% if api.components.schemas and schema_name in api.components.schemas and schema_name not in processed_schemas %}
                            {% set schema = api.components.schemas[schema_name] %}
                            {% set metadata = schemas_metadata.get(schema_name, {'source': 'Referenced', 'color': '#6B778C', 'is_array': false}) %}

                            {# Display main schema #}
                            <div class="panel-macro" style="margin-bottom: 20px; border: 2px solid {{ metadata.color }}; border-radius: 4px; padding: 16px;">
                                <h3 style="margin-top: 0; color: {{ metadata.color }};">
                                    {{ schema_name }}
                                    {% if metadata.is_array %}<small style="color: #6B778C;"> (array)</small>{% endif %}
                                </h3>
                                <p style="font-size: 12px; color: #6B778C; margin-bottom: 8px;">Used in: {{ metadata.source }}</p>
                                {% if schema.description %}
                                <p style="font-style: italic; color: #6B778C;">{{ schema.description }}</p>
                                {% endif %}

                                {% if schema.properties %}
                                <table class="confluence-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 25%;">Property</th>
                                            <th style="width: 20%;">Type</th>
                                            <th style="width: 15%;">Required</th>
                                            <th style="width: 40%;">Description</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for prop_name, prop in schema.properties.items() %}
                                        <tr>
                                            <td><code><strong>{{ prop_name }}</strong></code></td>
                                            <td>
                                                {% if prop.ref %}
                                                    {% set ref_schema_name = prop.ref.split('/')[-1] %}
                                                    <code style="color: {{ metadata.color }};">{{ ref_schema_name }}</code>
                                                    {# Add sub-schema to list if not already there #}
                                                    {% if ref_schema_name not in all_schemas_to_display %}
                                                        {% set _ = all_schemas_to_display.append(ref_schema_name) %}
                                                        {% set _ = schemas_metadata.update({ref_schema_name: {'source': schema_name + '.' + prop_name, 'color': '#6B778C', 'is_array': false}}) %}
                                                    {% endif %}
                                                {% elif prop.type == 'array' and prop.items %}
                                                    {% if prop.items.ref %}
                                                        {% set ref_schema_name = prop.items.ref.split('/')[-1] %}
                                                        <code>array[<span style="color: {{ metadata.color }};">{{ ref_schema_name }}</span>]</code>
                                                        {# Add sub-schema to list if not already there #}
                                                        {% if ref_schema_name not in all_schemas_to_display %}
                                                            {% set _ = all_schemas_to_display.append(ref_schema_name) %}
                                                            {% set _ = schemas_metadata.update({ref_schema_name: {'source': schema_name + '.' + prop_name, 'color': '#6B778C', 'is_array': true}}) %}
                                                        {% endif %}
                                                    {% else %}
                                                        <code>array[{{ prop.items.type or 'object' }}]</code>
                                                    {% endif %}
                                                {% else %}
                                                    <code>{{ prop.type or 'object' }}</code>
                                                    {% if prop.format %}
                                                    <br><small style="color: #6B778C;">format: {{ prop.format }}</small>
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if prop_name in (schema.required or []) %}
                                                <span class="status-lozenge status-warning">Required</span>
                                                {% else %}
                                                <span class="status-lozenge status-default">Optional</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ prop.description or '-' }}
                                                {% if prop.enum %}
                                                <br><small style="color: #6B778C;"><strong>Allowed:</strong> {{ prop.enum|join(', ') }}</small>
                                                {% endif %}
                                                {% if prop.default %}
                                                <br><small style="color: #6B778C;"><strong>Default:</strong> {{ prop.default }}</small>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                {% endif %}
                            </div>
                            {% set _ = processed_schemas.append(schema_name) %}
                        {% endif %}
                    {% endfor %}
                    </div>
                    {% endif %}
                    {# End of Complete Schema Reference - only shown if schemas exist #}
            </div>

            {% endif %}
        {% endfor %}
    {% endfor %}
{% endfor %}

