{# Schemas/Data Models Page #}
{% if api.components.schemas %}
{% set confluence_preview = true %}

<div id="page-schemas" class="page-content" style="display:none;">
    <div class="page-header">
        <h1 class="page-title">Data Models</h1>
        <div class="page-metadata">Schema Definitions</div>
        <div class="page-labels">
            <span class="label">schemas</span>
            <span class="label">models</span>
        </div>
    </div>

    <!-- Group schemas by tag based on endpoint usage -->
    {% for tag in api.tags %}
    <div class="content-section">
        <h2 class="section-title" id="schema-{{ tag.name }}">{{ tag.name }} Schemas</h2>

        {% set tag_schemas = [] %}
        {# Find schemas used by this tag's endpoints #}
        {% for path, path_item in api.paths.items() %}
            {% for method, operation in path_item.operations.items() %}
                {% if tag.name in operation.tags %}
                    {# Check request body schemas #}
                    {% if operation.request_body %}
                        {% for content_type, media_obj in operation.request_body.content.items() %}
                            {% if media_obj.schema and media_obj.schema.ref %}
                                {% set model_name = media_obj.schema.ref.split('/')[-1] %}
                                {% if model_name not in tag_schemas %}
                                    {% set _ = tag_schemas.append(model_name) %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    {# Check parameter schemas #}
                    {% if operation.parameters %}
                        {% for param in operation.parameters %}
                            {% if param.schema and param.schema.ref %}
                                {% set model_name = param.schema.ref.split('/')[-1] %}
                                {% if model_name not in tag_schemas %}
                                    {% set _ = tag_schemas.append(model_name) %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endfor %}

        {% if tag_schemas|length > 0 %}
            {% for schema_name in tag_schemas %}
                {% if schema_name in api.components.schemas %}
                    {% set schema = api.components.schemas[schema_name] %}
                    {% include 'partials/schema_card.html.j2' %}
                {% endif %}
            {% endfor %}
        {% else %}
            <p style="color: #6B778C; font-style: italic;">No schemas used by {{ tag.name }} endpoints.</p>
        {% endif %}
    </div>
    {% endfor %}

    <!-- Other schemas not associated with any tag -->
    {% set used_schemas = [] %}
    {% for tag in api.tags %}
        {% for path, path_item in api.paths.items() %}
            {% for method, operation in path_item.operations.items() %}
                {% if tag.name in operation.tags %}
                    {% if operation.request_body %}
                        {% for content_type, media_obj in operation.request_body.content.items() %}
                            {% if media_obj.schema and media_obj.schema.ref %}
                                {% set model_name = media_obj.schema.ref.split('/')[-1] %}
                                {% if model_name not in used_schemas %}
                                    {% set _ = used_schemas.append(model_name) %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    {% if operation.parameters %}
                        {% for param in operation.parameters %}
                            {% if param.schema and param.schema.ref %}
                                {% set model_name = param.schema.ref.split('/')[-1] %}
                                {% if model_name not in used_schemas %}
                                    {% set _ = used_schemas.append(model_name) %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endfor %}
    {% endfor %}

    {% set has_other_schemas = false %}
    {% for schema_name in api.components.schemas %}
        {% if schema_name not in used_schemas %}
            {% set has_other_schemas = true %}
        {% endif %}
    {% endfor %}

    {% if has_other_schemas %}
    <div class="content-section">
        <h2 class="section-title">Other Schemas</h2>
        {% for schema_name, schema in api.components.schemas.items() %}
            {% if schema_name not in used_schemas %}
                {% include 'partials/schema_card.html.j2' %}
            {% endif %}
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endif %}

